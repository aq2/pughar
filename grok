#!/bin/bash

# grok: integrates gulp and docker

# set locations
SOURCE="./test/"
DEV="angelo@drip:~/tripe/"
PUB="angelo@drip:~/pipe/"



# sync to server
function sync() {
  read -p 'Are you sure? ' -n 1 -r
  echo
  if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo 'nope'
    exit 1
  fi

  echo 'deploying...'
  rsync $SOURCE $1 --backup --backup-dir="bak_$(date +\\%Y-\\%m-\\%d)"   \
    --delete --exclude 'bak*' --human-readable --progress --recursive --verbose

}


# runs after ctrl-c
function ctrl_c() {
  echo 'Ctrl-c detected, shutting doon...'
  docker-compose down
}

# switch on argument
case "$1" in

  build)
    gulp build
    ;;

  dev)
    sync $DEV
    ;;

  pub)
    sync $PUB
    ;;

  down)
    docker-compose down
    ;;

  nuke)
    gulp nuke
    ;;

  up)
    docker-compose up
    ;;

  *)
    docker-compose up -d
    trap ctrl_c INT
    gulp
    ;;

esac

